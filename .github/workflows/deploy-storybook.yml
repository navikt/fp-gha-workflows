name: Deploy storybook
on:
  workflow_call:
    secrets:
      READER_TOKEN:
        description: "A token passed from the caller workflow"
        required: true
    inputs:
      runs-on:
        required: false
        type: string
        description: Milj√∏ versjon som skal brukes til bygg.
        default: "ubuntu-latest"
      package-manager:
        required: false
        type: string
        description: Package manager som skal brukes (pnpm|yarn).
        default: "yarn"
      node-version:
        required: false
        type: string
        description: Node version som brukes.
        default: "22"

env:
  NODE_OPTIONS: "--max_old_space_size=6144"
jobs:
  deploy-storybook:
    name: Deploy storybook ${{ inputs.package-manager }}
    permissions:
      contents: write
      pages: write
    environment: gh-pages
    runs-on: ${{ (github.event.pull_request.user.login == 'dependabot[bot]' && 'ubuntu-latest') || inputs.runs-on }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4

      - uses: navikt/fp-gha-workflows/.github/actions/setup-yarnrc@main
        if: inputs.package-manager == 'yarn'
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - uses: navikt/fp-gha-workflows/.github/actions/setup-npmrc@main
        if: inputs.package-manager == 'pnpm'
        with:
          npmAuthToken: ${{ secrets.READER_TOKEN }}

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # ratchet:pnpm/action-setup@v2
        if: inputs.package-manager == 'pnpm'
        with:
          version: 10.28.0

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # ratchet:actions/setup-node@v3
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}

      - name: Yarn install
        if: inputs.package-manager == 'yarn'
        run: |
          yarn install --immutable

      - name: Pnpm install
        if: inputs.package-manager == 'pnpm'
        run: |
          pnpm install --frozen-lockfile

      - name: Set remote url med token
        run: git remote set-url origin https://git:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git

      - name: Deploy storybook yarn
        if: inputs.package-manager == 'yarn'
        run: |
          yarn storybook-clean-deploy-folder && yarn storybook-build-all && yarn storybook-create-deploy-folder
          yarn gh-pages -d .storybook-static-build -t -u "github-actions-bot <support+actions@github.com>"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy storybook pnpm
        if: inputs.package-manager == 'pnpm'
        run: |
          pnpm storybook-deploy-clean-folder && pnpm storybook-deploy-build-all && pnpm storybook-deploy-create-folder
          pnpm gh-pages -d .storybook-static-build -t -u "github-actions-bot <support+actions@github.com>"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
